<tool id="fastga" name="FastGA" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>align whole genomes</description>
    <macros>
        <import>fastga_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        ## FastGA directly string matches the file extensions
        ## symlinks are used to bypass that restriction
        ln -s '$input1' 'input1.${input1.ext}' &&
        ln -s '$input2' 'input2.${input2.ext}' &&
        FastGA
        '${output_settings.out.format}'
        #if str( $output_settings.out.format ) == "-paf":
            #if str( $output_settings.out.cigar_string ) != "no":
                '${output_settings.out.cigar_string}'
            #end if
            #if str( $output_settings.out.cs_string ) != "no":
                '${output_settings.out.cs_string}'
            #end if
        #end if
        $use_soft_mask
        $use_sym_seeding
        -f${adaptive_seed_count_cutoff}
        -c${minimum_seed_coverage}
        -s${new_seed_threshold}
        -l${minimum_alignment_length}
        -i${minimum_alignment_identity}
        'input1.${input1.ext}' 'input2.${input2.ext}' 
        #if str( $output_settings.out.format ) != "-1:output":
            > output
        #end if
    ]]></command>
    <inputs>
        <param name="input1" type="data" label="FASTA sequence" format="fasta,fasta.gz"
            help="FASTA or gzip-compressed FASTA file of a high-quality genome assembly (Q40 or better). The order of inputs can affect results—FastGA is not commutative unless symmetric seeding (-S) is enabled."/>
        <param name="input2" type="data" label="FASTA sequence" format="fasta,fasta.gz"
            help="FASTA or gzip-compressed FASTA file of a high-quality genome assembly (Q40 or better). The order of inputs can affect results—FastGA is not commutative unless symmetric seeding (-S) is enabled."/>
        <param name="use_soft_mask" type="boolean" label="Use soft mask information if available (-M)" checked="false" truevalue="-M" falsevalue=""
            help="Use soft-masked regions (lowercase nucleotides) encoded in the genome index to guide alignment. Helps reduce spurious alignments in repeat-rich genomes by down-weighting repetitive regions during seed finding."/>
        <param name="use_sym_seeding" type="boolean" label="Use symmetric seeding (-S)" checked="false" truevalue="-S" falsevalue=""
            help="Generate seeds from both genomes instead of only from genome 1. Makes alignment results independent of input order at the cost of extra computation time. Generally not recommended for standard use."/>
        <param name="adaptive_seed_count_cutoff" type="integer" label="Adaptive seed count cutoff (-f)" value="10" min="0" max="255"
            help="Frequency threshold for repetitive adaptive seeds (adaptamers). Seeds occurring more than this many times across both genomes are excluded from seeding to prevent anchoring in repetitive regions. Lower values are more stringent. Range: 0–255."/>
        <param name="minimum_seed_coverage" type="integer" label="Minimum seed chain coverage in both genomes (-c)" value="85" min="0"
            help="Minimum base-pair span that a seed chain must cover in both genomes to be retained for alignment extension. Increasing this value reduces spurious short chains. Range: ≥ 0."/>
        <param name="new_seed_threshold" type="integer" label="Threshold for starting a new seed chain (-s)" value="1000" min="0"
            help="Maximum gap (in bp) allowed between consecutive seeds within a chain. Seeds further apart than this threshold start a new independent chain. Increasing this allows chaining across larger gaps; decreasing it produces more, shorter chains. Range: ≥ 0."/>
        <param name="minimum_alignment_length" type="integer" label="Minimum alignment length (-l)" value="100" min="0"
            help="Alignments shorter than this length (in bp) are discarded from the output. Increase to focus on longer syntenic blocks and reduce noise from short matches. Range: ≥ 0."/>
        <param name="minimum_alignment_identity" type="float" label="Minimum alignment identity (-i)" value="0.7" min="0.55" max="0.99999999999999994"
            help="Minimum sequence identity fraction required to report an alignment. For example, 0.7 requires at least 70% identity. Lower values permit more divergent alignments. Range: 0.55–&lt;1.0."/>
        <section name="output_settings" expanded="False" title="Output">
            <conditional name="out">
                <param name="format" type="select" label="Specify the output format"
                    help="Output format for alignments. PAF (Pairwise Alignment Format) is the default and most widely supported. PSL (Pattern Space Layout) is compatible with UCSC tools. 1ALN is a compact binary ONEcode format — note that 1ALN output is nondeterministic.">
                    <option value="-paf" selected="true">paf (-paf)</option>
                    <option value="-psl">psl (-psl)</option>
                    <option value="-1:output">1aln (-1)</option>
                </param>
                <when value="-paf">
                    <param name="cigar_string" type="select" label="Use CIGAR string?"
                        help="Optionally add a CIGAR string to PAF output (column 17). With X's (-pafx): mismatches are encoded as 'X', matches as '='. With ='s (-pafm): all aligned bases encoded as 'M'. Only one CIGAR style can be selected.">
                        <option value="no" selected="true">No CIGAR string</option>
                        <option value="-pafx">CIGAR string with X's (-pafx)</option>
                        <option value="-pafm">CIGAR string with ='s (-pafm)</option>
                    </param>
                    <param name="cs_string" type="select" label="Use CS string?"
                        help="Optionally add a CS difference string to PAF output. Short form (-pafs): compact encoding using ':', '*', '+', '-' operators. Long form (-pafS): full nucleotide-level representation. Only one CS style can be selected.">
                        <option value="no" selected="true">No CS string</option>
                        <option value="-pafs">CS string in short form (-pafs)</option>
                        <option value="-pafS">CS string in long form (-pafS)</option>
                    </param>
                </when>
                <when value="-psl"/>
                <when value="-1:output"/>
            </conditional>
        </section>
    </inputs>
    <outputs>
        <data name="output" format="paf" from_work_dir="output">
            <change_format>
                <when input="output_settings.out.format" value="-paf" format="paf"/>
                <when input="output_settings.out.format" value="-psl" format="psl"/>
                <when input="output_settings.out.format" value="-1:output" format="txt"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input1" value="chrM_hg38.fa.gz"/>
            <param name="input2" value="chrM_mm39.fa.gz"/>
            <section name="output_settings">
                <conditional name="out">
                    <param name="format" value="-paf"/>
                </conditional>
            </section>
            <output name="output" file="chrM_HGvMM.paf" ftype="paf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input1" value="chrM_hg38.fa.gz"/>
            <param name="input2" value="chrM_mm39.fa.gz"/>
            <section name="output_settings">
                <conditional name="out">
                    <param name="format" value="-psl"/>
                </conditional>
            </section>
            <output name="output" file="chrM_HGvMM.psl" ftype="psl"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input1" value="chrM_hg38.fa.gz"/>
            <param name="input2" value="chrM_mm39.fa.gz"/>
            <section name="output_settings">
                <conditional name="out">
                    <param name="format" value="-paf"/>
                    <param name="cigar_string" value="-pafx"/>
                </conditional>
            </section>
            <output name="output" file="pafx.paf" ftype="paf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input1" value="chrM_hg38.fa.gz"/>
            <param name="input2" value="chrM_mm39.fa.gz"/>
            <param name="use_soft_mask" value="True"/>
            <param name="use_sym_seeding" value="True"/>
            <param name="adaptive_seed_count_cutoff" value="9"/>
            <param name="minimum_seed_coverage" value="100"/>
            <param name="new_seed_threshold" value="750"/>
            <param name="minimum_alignment_length" value="90"/>
            <param name="minimum_alignment_identity" value="0.6"/>
            <section name="output_settings">
                <conditional name="out">
                    <param name="format" value="-paf"/>
                    <param name="cigar_string" value="-pafm"/>
                    <param name="cs_string" value="-pafS"/>
                </conditional>
            </section>
            <output name="output" file="pafmS_options.paf" ftype="paf"/>
        </test>
        <test expect_num_outputs="1">
            <param name="input1" value="chrM_hg38.fa.gz"/>
            <param name="input2" value="chrM_mm39.fa.gz"/>
            <section name="output_settings">
                <conditional name="out">
                    <param name="format" value="-1:output"/>
                </conditional>
            </section>
        </test>
    </tests>
    <help><![CDATA[

FastGA compares two high-quality genomes and outputs a ``.1aln``, ``.paf``, or ``.psl`` file containing all local alignments found.

It is based on a novel adaptive seed finding algorithm as well as the first wave-based local aligner developed for daligner (2012).

FastGA uses a number of temporary, hidden files such as ONEcode genome databases (.1gdb) and genome indices (.gix) to achieve its high speed and space efficiency.

-----

Input
*****

This tool takes two ``fasta`` or ``fasta.gz`` input files to align.

It is a core assumption of FastGA that the input genomes are nearly complete and are of high quality (Q40 or better).

FastGA is not commutative by default (see *Use symmetric seeding* below).

-----

Options
*******

    ===============================  ========  ===========  ===========================
    **Option**                       **Flag**  **Default**  **Description**
    -------------------------------  --------  -----------  ---------------------------
    Use soft mask information        -M        False        Use soft-masked regions if
                                                            present in the input FASTA
    Use symmetric seeding            -S        False        Enables symmetric seeding
                                                            (not recommended)
    Adaptive seed count cutoff       -f        10           Range: 0–255
    Minimum seed chain coverage      -c        85           Range: ≥ 0
    Threshold for new seed chain     -s        1000         Range: ≥ 0
    Minimum alignment length         -l        100          Range: ≥ 0
    Minimum alignment identity       -i        0.7          Range: 0.55–<1.0
    ===============================  ========  ===========  ===========================

-----

Output
******

**Output format**

    ==========  ========  ===========  ===============================
    **Format**  **Flag**  **Default**  **Notes**
    ----------  --------  -----------  -------------------------------
    PAF         -paf      Yes          
    PSL         -psl      No
    1ALN        -1        No           Output is nondeterministic
    ==========  ========  ===========  ===============================

**CIGAR string options**  

(available only when output format is PAF)

    ==============================  ========  ===========
    **Option**                      **Flag**  **Default**
    ------------------------------  --------  -----------
    No CIGAR string                           Yes
    CIGAR string with X's           -pafx     No
    CIGAR string with ='s           -pafm     No
    ==============================  ========  ===========

**CS string options**  

(available only when output format is PAF)

    ==============================  ========  ===========
    **Option**                      **Flag**  **Default**
    ------------------------------  --------  -----------
    No CS string                              Yes
    CS string (short form)          -pafs     No
    CS string (long form)           -pafS     No
    ==============================  ========  ===========

]]></help>
    <expand macro="citations" />
</tool>
